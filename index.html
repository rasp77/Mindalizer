<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mindalizer • Assistente</title>
  <style>
    :root{
      --bg:#0b1020; --panel:#0f172a; --muted:#94a3b8;
      --bubble-user:#2563eb; --bubble-bot:#1f2937;
      --accent:#22d3ee; --ring:rgba(34,211,238,.35)
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:#e5e7eb; font-size:18px;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Noto Sans",Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(34,211,238,.08), transparent 40%),
        radial-gradient(1000px 500px at 100% 0%, rgba(37,99,235,.08), transparent 40%),
        var(--bg);
      display:grid; grid-template-rows:auto 1fr auto; height:100vh;
    }
    header{
      display:flex; align-items:center; gap:12px;
      padding:14px 18px; border-bottom:1px solid #1f2937;
      background:rgba(17,24,39,.85); backdrop-filter:blur(8px);
      position:sticky; top:0; z-index:10; box-shadow:0 6px 24px rgba(0,0,0,.25);
    }
    header h1{margin:0; font-size:16px; font-weight:700}
    header .sub{color:var(--muted); font-size:12px}
    header .spacer{flex:1}
    .brand{height:24px; width:auto; object-fit:contain}
    main#chat{
      padding:22px; overflow-y:auto; display:flex; flex-direction:column; gap:12px;
      width:100%; max-width:920px; margin:0 auto;
    }
    .row{display:flex}
    .row.user{justify-content:flex-end}
    .msg{
      max-width:78ch; padding:14px 16px; border-radius:16px;
      line-height:1.55; white-space:pre-wrap; word-wrap:break-word;
      box-shadow:0 6px 14px rgba(0,0,0,.18);
    }
    .user .msg{background:var(--bubble-user); color:#fff; border-bottom-right-radius:8px}
    .bot  .msg{background:var(--bubble-bot);  color:#e5e7eb; border-bottom-left-radius:8px}
    .typing{display:inline-flex; gap:4px; align-items:center}
    .dot{width:6px;height:6px;background:#94a3b8;border-radius:999px;opacity:.4;animation:blink 1.2s infinite}
    .dot:nth-child(2){animation-delay:.2s}.dot:nth-child(3){animation-delay:.4s}
    @keyframes blink{0%,80%,100%{opacity:.2}40%{opacity:.9}}
    .bar{
      display:flex; gap:10px; padding:14px 18px; border-top:1px solid #1f2937;
      background:rgba(17,24,39,.85); backdrop-filter:blur(8px)
    }
    .bar input{
      flex:1; padding:14px 16px; border-radius:14px; border:1px solid #374151;
      background:#0b1220; color:#e5e7eb; outline:none; font-size:18px;
      box-shadow:0 0 0 0 var(--ring)
    }
    .bar input:focus{border-color:var(--accent); box-shadow:0 0 0 3px var(--ring)}
    .bar button{
      padding:12px 18px; border:none; border-radius:12px; font-size:18px; font-weight:700;
      background:linear-gradient(180deg,#3b82f6,#2563eb); color:#fff; cursor:pointer;
      box-shadow:0 10px 20px rgba(37,99,235,.25); transition:transform .06s ease
    }
    .bar button:active{transform:translateY(1px)}
    .bar .ghost{
      background:#0b1220; color:#e5e7eb; border:1px solid #374151;
      box-shadow:none; font-weight:600;
    }
    footer{padding:8px 14px; color:var(--muted); font-size:12px; text-align:center}
  </style>
</head>
<body>
  <header>
    <img id="logoLeft"  class="brand" alt="Magomar" />
    <div>
      <h1>Mindalizer • Assistente</h1>
      <div class="sub">Conversa demo ligada ao webhook n8n</div>
    </div>
    <div class="spacer"></div>
    <img id="logoRight" class="brand" alt="Mindalizer" />
  </header>

  <main id="chat" aria-live="polite"></main>

  <div class="bar">
    <input id="text" type="text" placeholder="Escreve a tua mensagem…" autocomplete="off" />
    <button id="send">Enviar</button>
    <button id="reset" class="ghost" title="Começar nova conversa">Nova conversa</button>
  </div>

  <footer>Dica: se não aparecer resposta, confirma o fluxo no n8n e CORS.</footer>

  <script>
    // CONFIGURAÇÃO
    const WEBHOOK_URL = 'https://mindalizerai.app.n8n.cloud/webhook/d51a65db-fa9f-462e-9ff2-20a728c0e97e';

    // Frase que indica fim de encomenda
    const RESET_PHRASE = 'A sua encomenda foi registada com sucesso e enviada para a nossa equipa. Receberá um email com os detalhes em breve.';

    // Substitui por logos reais
    const LOGO_LEFT_URL  = 'https://upload.wikimedia.org/wikipedia/commons/3/3f/Placeholder.png';
    const LOGO_RIGHT_URL = 'https://upload.wikimedia.org/wikipedia/commons/3/3f/Placeholder.png';

    window.addEventListener('DOMContentLoaded', () => {
      const L = document.getElementById('logoLeft');
      const R = document.getElementById('logoRight');
      if (LOGO_LEFT_URL)  L.src = LOGO_LEFT_URL;
      if (LOGO_RIGHT_URL) R.src = LOGO_RIGHT_URL;
    });

    // helpers
    const $ = (id) => document.getElementById(id);
    const chat = $('chat'), input = $('text'), btn = $('send'), resetBtn = $('reset');

    // gestão da sessão
    const SKEY = 'mindalizer_session_id';
    const HKEY = 'mindalizer_chat_history';

    const newSessionId = () =>
      Math.random().toString(36).slice(2) + Date.now().toString(36);

    const getSessionId = () => {
      let v = localStorage.getItem(SKEY);
      if (!v) { v = newSessionId(); localStorage.setItem(SKEY, v); }
      return v;
    };

    let sessionId = getSessionId();

    const loadH = () => JSON.parse(localStorage.getItem(HKEY) || '[]');
    const saveH = (h) => localStorage.setItem(HKEY, JSON.stringify(h));

    function addMsg(text, who='bot'){
      const row = document.createElement('div'); row.className = `row ${who}`;
      const bubble = document.createElement('div'); bubble.className = 'msg'; bubble.textContent = text;
      row.appendChild(bubble); chat.appendChild(row); chat.scrollTop = chat.scrollHeight;
    }

    let typingEl = null;
    function showTyping(){
      typingEl = document.createElement('div'); typingEl.className = 'row bot';
      const b = document.createElement('div'); b.className = 'msg';
      const dots = document.createElement('span'); dots.className = 'typing';
      dots.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
      b.appendChild(dots); typingEl.appendChild(b); chat.appendChild(typingEl); chat.scrollTop = chat.scrollHeight;
    }
    function hideTyping(){ if(typingEl){ typingEl.remove(); typingEl=null; } }

    function clearChatUI(){
      chat.innerHTML = '';
      addMsg('Olá! Sou o assistente da Mindalizer. Como posso ajudar?');
    }

    function hardReset(){
      localStorage.removeItem(HKEY);
      localStorage.removeItem(SKEY);
      sessionId = newSessionId();
      localStorage.setItem(SKEY, sessionId);
      clearChatUI();
      input.value = '';
      input.focus();
    }

    async function send(){
      const text = input.value.trim(); if(!text) return;
      input.value=''; btn.disabled=true; addMsg(text,'user');
      const hist = loadH(); hist.push({who:'user', text}); saveH(hist);

      showTyping();
      try{
        const res = await fetch(WEBHOOK_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ message: text, sessionId })
        });
        const ct = res.headers.get('content-type') || '';
        let botText = '';
        if (ct.includes('application/json')){
          const data = await res.json();
          botText = data.reply || data.message || data.output || data.response || JSON.stringify(data, null, 2);
        } else {
          botText = await res.text();
        }
        hideTyping(); addMsg(botText || 'Sem resposta disponível.');
        const h2 = loadH(); h2.push({who:'bot', text: botText}); saveH(h2);

        // detecção do fim da encomenda e reset automático
        if (botText && botText.includes(RESET_PHRASE)){
          setTimeout(() => {
            addMsg('Conversa finalizada. A iniciar nova conversa…');
            setTimeout(hardReset, 900);
          }, 600);
        }
      } catch(e){
        hideTyping(); addMsg('Erro ao contactar o servidor. Verifica CORS e URL.', 'bot');
      } finally {
        btn.disabled=false; input.focus();
      }
    }

    btn.addEventListener('click', send);
    input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });
    resetBtn.addEventListener('click', hardReset);

    // arranque
    (function init(){
      const h = loadH();
      if(h.length===0) addMsg('Olá! Sou o assistente da Mindalizer. Como posso ajudar?');
      else h.forEach(m=> addMsg(m.text, m.who));
      input.focus();
    })();
  </script>
</body>
</html>
